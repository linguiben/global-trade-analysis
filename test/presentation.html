<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é¥¿äº†ä¹ˆæ¨èç³»ç»Ÿæ•°æ®åˆ†ææŠ¥å‘Š - ä¸šåŠ¡æ´å¯Ÿä»ªè¡¨ç›˜</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<style>
    :root {
        font-size: 14px;
        --primary-color: #0091ff;
        --success-color: #52c41a;
        --warning-color: #faad14;
        --danger-color: #f5222d;
        --border-color: #e8e8e8;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        line-height: 1.6;
        padding: 1rem;
        min-height: 100vh;
    }
    
    .container {
        max-width: 1600px;
        margin: 0 auto;
    }
    
    .header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        text-align: center;
    }
    
    .header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .header p {
        font-size: 1rem;
        opacity: 0.95;
        margin-bottom: 0.3rem;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .metric-card {
        background: white;
        padding: 1.2rem;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        text-align: center;
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
    }
    
    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.3rem;
    }
    
    .metric-change {
        font-size: 0.85rem;
        color: var(--success-color);
    }

    .explain-note {
        margin-top: 0.4rem;
        padding: 0.55rem 0.75rem;
        border-left: 3px solid #91d5ff;
        background: #f6fbff;
        border-radius: 6px;
        color: #4a5a6a;
        font-size: 0.84rem;
    }

    .effect-kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.8rem;
        margin-top: 0.8rem;
    }

    .effect-kpi-card {
        border: 1px solid #d9e8ff;
        background: linear-gradient(180deg, #ffffff 0%, #f7fbff 100%);
        border-radius: 10px;
        padding: 0.9rem 1rem;
    }

    .effect-kpi-label {
        font-size: 0.85rem;
        color: #5a6b84;
    }

    .effect-kpi-value {
        margin-top: 0.2rem;
        font-size: 1.5rem;
        line-height: 1.2;
        font-weight: 700;
        color: #0050b3;
    }

    .effect-kpi-formula {
        margin-top: 0.3rem;
        font-size: 0.8rem;
        color: #76859b;
    }
    
    .section {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    
    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.2rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid var(--primary-color);
    }
    
    .section-icon {
        font-size: 1.8rem;
        margin-right: 0.8rem;
    }
    
    .section-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #1a1a1a;
    }
    
    .section-subtitle {
        font-size: 0.9rem;
        color: #666;
        margin-left: auto;
    }
    
    .chart {
        height: 420px;
        width: 100%;
        margin-top: 1rem;
    }
    
    .chart-small {
        height: 320px;
    }
    
    .chart-medium {
        height: 380px;
    }
    
    .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    
    .table-wrapper {
        max-height: 500px;
        overflow: auto;
        margin-top: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .sample-table-wrapper {
        overflow-x: auto;
        overflow-y: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .sample-data-table {
        min-width: max-content;
        table-layout: auto;
    }

    .sample-data-table th,
    .sample-data-table td {
        white-space: nowrap;
        min-width: 120px;
    }
    
    th, td {
        padding: 0.75rem 1rem;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
    }
    
    th {
        background: linear-gradient(to bottom, #fafafa, #f0f0f0);
        font-weight: 600;
        color: #333;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    tbody tr:hover {
        background-color: #f5f5f5;
    }
    
    .footer {
        text-align: center;
        color: white;
        padding: 1.5rem;
        margin-top: 2rem;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        backdrop-filter: blur(10px);
    }
    
    .tag {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .tag-vip {
        background: #fff7e6;
        color: #fa8c16;
        border: 1px solid #ffd591;
    }
    
    .tag-high {
        background: #f6ffed;
        color: #52c41a;
        border: 1px solid #b7eb8f;
    }
    
    .tag-medium {
        background: #e6f7ff;
        color: #1890ff;
        border: 1px solid #91d5ff;
    }
    
    .tag-low {
        background: #fff1f0;
        color: #ff4d4f;
        border: 1px solid #ffccc7;
    }
    
    @media (max-width: 768px) {
        .two-column {
            grid-template-columns: 1fr;
        }
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        .header h1 {
            font-size: 1.5rem;
        }
    }
</style>
</head>
<body>

<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="header">
        <h1>ğŸ” é¥¿äº†ä¹ˆæ¨èç³»ç»Ÿæ•°æ®åˆ†ææŠ¥å‘Š</h1>
        <p>æ•°æ®æ¥æºå¤©æ± æ•°æ®é›†</p>
        <p style="font-size: 0.85rem; opacity: 0.8;">åˆ†ææ—¶æ®µ: 20220401~20220407 | æ•°æ®è§„æ¨¡: 0æ¡è®°å½•</p>
    </div>
    
    <!-- æ ¸å¿ƒæŒ‡æ ‡æ¦‚è§ˆ -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">æ€»æ›å…‰é‡</div>
            <div class="metric-value">0</div>
            <div class="metric-change">ğŸ“Š å…¨é‡æ•°æ®</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">æ€»ç‚¹å‡»é‡</div>
            <div class="metric-value">0</div>
            <div class="metric-change">âœ… æ´»è·ƒç”¨æˆ·å“åº”</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">å…¨å±€ç‚¹å‡»ç‡ (CTR)</div>
            <div class="metric-value">0%</div>
            <div class="metric-change">ğŸ“ˆ è¡Œä¸šä¸­ä½æ°´å¹³</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">è½¬åŒ–ç‡ (CVR)</div>
            <div class="metric-value">0%</div>
            <div class="metric-change">ğŸ¯ æ¨èç²¾å‡†åº¦æŒ‡æ ‡</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">å¹³å‡å®¢å•ä»·</div>
            <div class="metric-value">Â¥0</div>
            <div class="metric-change">ğŸ’° ç”¨æˆ·æ¶ˆè´¹èƒ½åŠ›</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">æ´»è·ƒç”¨æˆ·æ•°</div>
            <div class="metric-value">0</div>
            <div class="metric-change">ğŸ‘¥ ç‹¬ç«‹ç”¨æˆ·è®¿é—®</div>
        </div>
    </div>
    
    <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šç”¨æˆ·ç”»åƒåˆ†æ -->
    <div class="section">
        <div class="section-header">
            <span class="section-icon">ğŸ‘¥</span>
            <h2 class="section-title">ç”¨æˆ·å…¨æ™¯ç”»åƒä¸åˆ†å±‚è¿è¥</h2>
            <span class="section-subtitle">User Insights Â· RFMåˆ†å±‚æ¨¡å‹</span>
        </div>
        
        <div class="two-column">
            <div>
                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #555;">ç”¨æˆ·ä»·å€¼åˆ†å±‚åˆ†å¸ƒ</h3>
                <div id="userSegmentPie" class="chart chart-small"></div>
            </div>
            <div>
                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #555;">å„å±‚çº§ç”¨æˆ·å¹³å‡æ¶ˆè´¹é‡‘é¢</h3>
                <div id="userValueBar" class="chart chart-small"></div>
            </div>
        </div>
        
        <h3 style="font-size: 1.1rem; margin: 1.5rem 0 0.5rem; color: #555;">VIPç”¨æˆ·ä»·å€¼å¯¹æ¯”ï¼ˆæ¶ˆè´¹ç±»æŒ‡æ ‡ï¼‰</h3>
        <p class="explain-note">æœ¬å›¾ä»…å±•ç¤ºæ¶ˆè´¹ä»·å€¼æŒ‡æ ‡ï¼šå¹³å‡å®¢å•ä»·ã€30å¤©ä¸‹å•æ¬¡æ•°ã€‚ç‚¹å‡»/è½¬åŒ–ç›¸å…³æŒ‡æ ‡å·²ç§»è‡³ä¸‹æ–¹â€œè¡Œä¸ºè¦†ç›–ç‡â€å’Œâ€œå…¨å±€æ•ˆæœæŒ‡æ ‡â€ã€‚</p>
        <div id="vipComparison" class="chart chart-medium"></div>
        
        <h3 style="font-size: 1.1rem; margin: 1.5rem 0 0.5rem; color: #555;">å¹³å‡å®¢å•ä»·å¯¹æ¯”åˆ†æ â€“ åŸºäºæ€§åˆ«</h3>
        <div id="genderComparison" class="chart chart-medium"></div>
        
        <h3 style="font-size: 1.1rem; margin: 1.5rem 0 0.5rem; color: #555;">å…¨å±€æ•ˆæœæŒ‡æ ‡ï¼ˆæ›å…‰å£å¾„ï¼‰</h3>
        <div class="effect-kpi-grid">
            <div class="effect-kpi-card">
                <div class="effect-kpi-label">å…¨å±€ç‚¹å‡»ç‡ CTR</div>
                <div id="globalCtrValue" class="effect-kpi-value">--</div>
                <div id="globalCtrFormula" class="effect-kpi-formula">å£å¾„ï¼šæ€»ç‚¹å‡»é‡ / æ€»æ›å…‰é‡</div>
            </div>
            <div class="effect-kpi-card">
                <div class="effect-kpi-label">å…¨å±€è½¬åŒ–ç‡ CVR</div>
                <div id="globalCvrValue" class="effect-kpi-value">--</div>
                <div id="globalCvrFormula" class="effect-kpi-formula">å£å¾„ï¼šsum(ord_30) / sum(ctr_30)</div>
            </div>
        </div>

        <h3 style="font-size: 1.1rem; margin: 1.5rem 0 0.5rem; color: #555;">å„å±‚ç”¨æˆ·30å¤©è¡Œä¸ºè¦†ç›–ç‡ï¼ˆç”¨æˆ·å£å¾„ï¼‰</h3>
        <p class="explain-note">è¯´æ˜ï¼šè¯¥å›¾ä¸æ˜¯æ›å…‰CTR/CVRï¼Œç»Ÿè®¡çš„æ˜¯â€œè¯¥å±‚ç”¨æˆ·ä¸­ï¼Œ30å¤©å†…è‡³å°‘æœ‰ä¸€æ¬¡ç‚¹å‡»/ä¸‹å•â€çš„ç”¨æˆ·å æ¯”ã€‚</p>
        <div id="segmentConversion" class="chart chart-medium"></div>
    </div>
    
    <!-- ç¬¬äºŒéƒ¨åˆ†:è¡Œä¸ºåˆ†æ -->
    <div class="section">
        <div class="section-header">
            <span class="section-icon">ğŸ“Š</span>
            <h2 class="section-title">ç”¨æˆ·è¡Œä¸ºå†³ç­–åˆ†æ</h2>
            <span class="section-subtitle">Behavioral Insights Â· æ—¶é—´ä¸è½¬åŒ–åˆ†æ</span>
        </div>
        
        <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #555;">24å°æ—¶ç‚¹å‡»é‡ä¸ä¸‹å•é‡è¶‹åŠ¿å¯¹æ¯”ï¼ˆæŒ‰ç”¨æˆ·ç­‰çº§ï¼‰</h3>
        
        <!-- ç”¨æˆ·ç­‰çº§Tabåˆ‡æ¢ -->
        <div class="segment-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <button class="segment-tab active" data-segment="super_vip" style="padding: 0.5rem 1rem; border: 2px solid var(--primary-color); background: var(--primary-color); color: white; border-radius: 6px; cursor: pointer; font-weight: 500;">ğŸ‘‘ è¶…çº§VIP</button>
            <button class="segment-tab" data-segment="potential" style="padding: 0.5rem 1rem; border: 2px solid var(--primary-color); background: white; color: var(--primary-color); border-radius: 6px; cursor: pointer; font-weight: 500;">â­ æ½œåŠ›ä¼˜è´¨</button>
            <button class="segment-tab" data-segment="active" style="padding: 0.5rem 1rem; border: 2px solid var(--primary-color); background: white; color: var(--primary-color); border-radius: 6px; cursor: pointer; font-weight: 500;">ğŸ”¥ å¤§ä¼—æ´»è·ƒ</button>
            <button class="segment-tab" data-segment="normal" style="padding: 0.5rem 1rem; border: 2px solid var(--primary-color); background: white; color: var(--primary-color); border-radius: 6px; cursor: pointer; font-weight: 500;">ğŸ“¦ ä¸€èˆ¬ç”¨æˆ·</button>
            <button class="segment-tab" data-segment="churn" style="padding: 0.5rem 1rem; border: 2px solid var(--primary-color); background: white; color: var(--primary-color); border-radius: 6px; cursor: pointer; font-weight: 500;">âš ï¸ æµå¤±é£é™©</button>
        </div>
        
        <!-- 5å¼ 24å°æ—¶è¶‹åŠ¿å›¾å®¹å™¨ -->
        <div id="hourlyTrend_super_vip" class="chart hourly-segment-chart" style="display: block;"></div>
        <div id="hourlyTrend_potential" class="chart hourly-segment-chart" style="display: none;"></div>
        <div id="hourlyTrend_active" class="chart hourly-segment-chart" style="display: none;"></div>
        <div id="hourlyTrend_normal" class="chart hourly-segment-chart" style="display: none;"></div>
        <div id="hourlyTrend_churn" class="chart hourly-segment-chart" style="display: none;"></div>
        
        <h3 style="font-size: 1.1rem; margin: 1.5rem 0 0.5rem; color: #555;">å·¥ä½œæ—¥ vs éå·¥ä½œæ—¥è¡Œä¸ºå¯¹æ¯”</h3>
        <div id="weekdayComparison" class="chart chart-medium"></div>
    </div>
    
    <!-- ç¬¬å››éƒ¨åˆ†:æ•°æ®æ˜ç»†è¡¨ -->
    <div class="section">
        <div class="section-header">
            <span class="section-icon">ğŸ“‹</span>
            <h2 class="section-title">æ ¸å¿ƒæ•°æ®æ˜ç»†è¡¨</h2>
            <span class="section-subtitle">Data Summary Â· å…³é”®æŒ‡æ ‡æ±‡æ€»</span>
        </div>
        
        <div class="table-wrapper">
            <table id="summaryTable">
                <thead>
                    <tr>
                        <th>åˆ†æç»´åº¦</th>
                        <th>æŒ‡æ ‡åç§°</th>
                        <th>æ•°å€¼</th>
                        <th>å¯¹æ¯”åŸºå‡†</th>
                        <th>è¯„çº§</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    
    <!-- ç¬¬äº”éƒ¨åˆ†:åŸå§‹æ•°æ®æ ·ä¾‹ -->
    <div class="section">
        <div class="section-header">
            <span class="section-icon">ğŸ”¬</span>
            <h2 class="section-title">åŸå§‹æ•°æ®æ ·ä¾‹</h2>
            <span class="section-subtitle">Data Samples Â· æŸ¥çœ‹æ•°æ®ç»“æ„</span>
        </div>
        
        <p style="color: #666; margin-bottom: 1rem;">ä»¥ä¸‹å±•ç¤º10æ¡çœŸå®æ ·ä¾‹æ•°æ®ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ•°æ®ç»“æ„å’Œå­—æ®µå†…å®¹ï¼š</p>
        
        <div class="table-wrapper sample-table-wrapper">
            <table id="sampleDataTable" class="sample-data-table">
                <thead>
                    <tr id="sampleDataHeadRow"></tr>
                </thead>
                <tbody id="sampleDataBody"></tbody>
            </table>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <div class="footer">
        <p>Â© 2026 é¥¿äº†ä¹ˆæ¨èç³»ç»Ÿæ•°æ®åˆ†æé¡¹ç›® | æ•°æ®æ¥æºå¤©æ± æ•°æ®é›†</p>
        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.9;">
            æŠ€æœ¯æ ˆ: Python 3.12 Â· Pandas Â· NumPy Â· Matplotlib Â· ECharts
        </p>
        <p style="font-size: 0.85rem; margin-top: 0.4rem; opacity: 0.95;">
            <a href="https://gitee.com/linguiben/da-elm#%E8%AE%B8%E5%8F%AF%E5%A3%B0%E6%98%8E" target="_blank" rel="noopener noreferrer" style="color: #fff; text-decoration: underline;">è®¸å¯å£°æ˜</a>
        </p>
    </div>
</div>

<script>
// ========== æ•°æ®å®šä¹‰ ==========

// ç”¨æˆ·åˆ†å±‚æ•°æ®
const userSegmentData = [
    { name: 'ğŸ‘‘ è¶…çº§VIPç”¨æˆ·', value: 0, color: '#faad14' },
    { name: 'ğŸ’ æ½œåŠ›ä¼˜è´¨ç”¨æˆ·', value: 0, color: '#1890ff' },
    { name: 'ğŸ’° å¤§ä¼—æ´»è·ƒç”¨æˆ·', value: 0, color: '#52c41a' },
    { name: 'ğŸ‘¤ ä¸€èˆ¬ç”¨æˆ·', value: 0, color: '#8c8c8c' },
    { name: 'ğŸ”„ æµå¤±é£é™©ç”¨æˆ·', value: 0, color: '#f5222d' }
];

const userValueData = {
    categories: ['è¶…çº§VIP', 'æ½œåŠ›ä¼˜è´¨', 'å¤§ä¼—æ´»è·ƒ', 'ä¸€èˆ¬ç”¨æˆ·', 'æµå¤±é£é™©'],
    values: [0, 0, 0, 0, 0]
};

// VIPå¯¹æ¯”æ•°æ®ï¼ˆåŸå§‹ç»“æ„: ç‚¹å‡»ç‡/è½¬åŒ–ç‡/å®¢å•ä»·/30å¤©ä¸‹å•æ¬¡æ•°ï¼‰
const vipData = {
    categories: ['ç‚¹å‡»ç‡(%)', 'è½¬åŒ–ç‡(%)', 'å¹³å‡å®¢å•ä»·(å…ƒ)', '30å¤©ä¸‹å•æ¬¡æ•°'],
    vip: [0, 0, 0, 0],
    normal: [0, 0, 0, 0],
    unknown: [0, 0, 0, 0]
};

// æ€§åˆ«å¯¹æ¯”æ•°æ®ï¼ˆæŒ‰RFMç­‰çº§çš„å¹³å‡å®¢å•ä»·ï¼‰
const genderComparisonData = {
    categories: ['è¶…çº§VIP', 'æ½œåŠ›ä¼˜è´¨', 'å¤§ä¼—æ´»è·ƒ', 'ä¸€èˆ¬ç”¨æˆ·', 'æµå¤±é£é™©'],
    male: [0, 0, 0, 0, 0],
    female: [0, 0, 0, 0, 0],
    unknown: [0, 0, 0, 0, 0]
};

// å„å±‚ç”¨æˆ·è¡Œä¸ºè¦†ç›–ç‡ï¼ˆ30å¤©å£å¾„ï¼‰
const segmentConversionData = {
    categories: ['è¶…çº§VIP', 'æ½œåŠ›ä¼˜è´¨', 'å¤§ä¼—æ´»è·ƒ', 'ä¸€èˆ¬ç”¨æˆ·', 'æµå¤±é£é™©'],
    click_rate: [0, 0, 0, 0, 0],
    conversion_rate: [0, 0, 0, 0, 0]
};

// 24å°æ—¶è¶‹åŠ¿æ•°æ®ï¼ˆæŒ‰ç”¨æˆ·ç­‰çº§åˆ†ç»„ï¼‰
const hourlyBySegmentData = {
    super_vip: { hours: Array.from({length: 24}, (_, i) => i), clicks: Array(24).fill(0), orders: Array(24).fill(0) },
    potential: { hours: Array.from({length: 24}, (_, i) => i), clicks: Array(24).fill(0), orders: Array(24).fill(0) },
    active: { hours: Array.from({length: 24}, (_, i) => i), clicks: Array(24).fill(0), orders: Array(24).fill(0) },
    normal: { hours: Array.from({length: 24}, (_, i) => i), clicks: Array(24).fill(0), orders: Array(24).fill(0) },
    churn: { hours: Array.from({length: 24}, (_, i) => i), clicks: Array(24).fill(0), orders: Array(24).fill(0) }
};

// å·¥ä½œæ—¥vséå·¥ä½œæ—¥
const weekdayData = {
    metrics: ['ç‚¹å‡»é‡', 'ä¸‹å•é‡'],
    weekday: [0, 0],
    weekend: [0, 0]
};

// æ˜ç»†è¡¨æ•°æ®
const summaryTableData = [];

// æ ·ä¾‹æ•°æ®
const sampleTableData = {
    headers: [],
    rows: []
};

// ========== å›¾è¡¨æ¸²æŸ“å‡½æ•° ==========

function initCharts() {
    const globalMetrics = (typeof metricsData !== 'undefined' && metricsData) ? metricsData : {};
    const toNumberOrNull = (v) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
    };

    const ctrValueEl = document.getElementById('globalCtrValue');
    const cvrValueEl = document.getElementById('globalCvrValue');
    if (ctrValueEl) {
        const ctr = toNumberOrNull(globalMetrics.global_ctr);
        ctrValueEl.textContent = ctr === null ? '--' : `${ctr.toFixed(2)}%`;
    }
    if (cvrValueEl) {
        const cvr = toNumberOrNull(globalMetrics.global_cvr);
        cvrValueEl.textContent = cvr === null ? '--' : `${cvr.toFixed(2)}%`;
    }

    // 1. ç”¨æˆ·åˆ†å±‚é¥¼å›¾
    const segmentChart = echarts.init(document.getElementById('userSegmentPie'));
    segmentChart.setOption({
        tooltip: { trigger: 'item', formatter: '{b}: {c}%<br/>å æ¯”: {d}%' },
        legend: { bottom: 0, data: userSegmentData.map(d => d.name) },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: true,
            itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
            label: { show: true, formatter: '{b}\n{c}%' },
            data: userSegmentData.map(d => ({ 
                name: d.name, 
                value: d.value,
                itemStyle: { color: d.color }
            }))
        }]
    });
    
    // 2. ç”¨æˆ·ä»·å€¼æŸ±çŠ¶å›¾
    const valueChart = echarts.init(document.getElementById('userValueBar'));
    valueChart.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        xAxis: { type: 'category', data: userValueData.categories },
        yAxis: { type: 'value', name: 'å¹³å‡æ¶ˆè´¹(å…ƒ)' },
        series: [{
            type: 'bar',
            data: userValueData.values,
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#83bff6' },
                    { offset: 1, color: '#188df0' }
                ]),
                borderRadius: [6, 6, 0, 0]
            },
            label: { show: true, position: 'top', formatter: 'Â¥{c}' }
        }]
    });
    
    // 3. VIPä»·å€¼å¯¹æ¯”å›¾ï¼ˆä»…æ¶ˆè´¹ç±»æŒ‡æ ‡ï¼‰
    const vipCategories = ['å¹³å‡å®¢å•ä»·(å…ƒ)', '30å¤©ä¸‹å•æ¬¡æ•°'];
    const vipValueData = {
        vip: [
            toNumberOrNull(vipData?.vip?.[2]),
            toNumberOrNull(vipData?.vip?.[3])
        ],
        normal: [
            toNumberOrNull(vipData?.normal?.[2]),
            toNumberOrNull(vipData?.normal?.[3])
        ],
        unknown: [
            toNumberOrNull(vipData?.unknown?.[2]),
            toNumberOrNull(vipData?.unknown?.[3])
        ]
    };
    const vipChart = echarts.init(document.getElementById('vipComparison'));
    vipChart.setOption({
        tooltip: {
            trigger: 'axis',
            formatter: (params) => {
                if (!params || params.length === 0) return '';
                const category = params[0].axisValue;
                const unit = category === 'å¹³å‡å®¢å•ä»·(å…ƒ)' ? 'å…ƒ' : 'æ¬¡';
                const lines = params.map((p) => {
                    const val = p.value === null || p.value === undefined ? '-' : `${p.value}${unit}`;
                    return `${p.marker}${p.seriesName}: ${val}`;
                });
                return `${category}<br/>${lines.join('<br/>')}`;
            }
        },
        legend: { data: ['VIPç”¨æˆ·', 'éVIPç”¨æˆ·', 'æœªçŸ¥'], top: 0 },
        xAxis: { type: 'category', data: vipCategories },
        yAxis: { type: 'value', name: 'æŒ‡æ ‡å€¼' },
        series: [
            {
                name: 'VIPç”¨æˆ·',
                type: 'bar',
                data: vipValueData.vip,
                itemStyle: { color: '#faad14', borderRadius: [6, 6, 0, 0] },
                label: {
                    show: true,
                    position: 'top',
                    formatter: (p) => {
                        if (p.value === null || p.value === undefined) return '-';
                        return p.dataIndex === 0 ? `Â¥${p.value}` : `${p.value}`;
                    }
                }
            },
            {
                name: 'éVIPç”¨æˆ·',
                type: 'bar',
                data: vipValueData.normal,
                itemStyle: { color: '#8c8c8c', borderRadius: [6, 6, 0, 0] },
                label: {
                    show: true,
                    position: 'top',
                    formatter: (p) => {
                        if (p.value === null || p.value === undefined) return '-';
                        return p.dataIndex === 0 ? `Â¥${p.value}` : `${p.value}`;
                    }
                }
            },
            {
                name: 'æœªçŸ¥',
                type: 'bar',
                data: vipValueData.unknown,
                itemStyle: { color: '#d9d9d9', borderRadius: [6, 6, 0, 0] },
                label: {
                    show: true,
                    position: 'top',
                    formatter: (p) => {
                        if (p.value === null || p.value === undefined) return '-';
                        return p.dataIndex === 0 ? `Â¥${p.value}` : `${p.value}`;
                    }
                }
            }
        ]
    });
    
    // 4. æ€§åˆ«å¯¹æ¯”å›¾ï¼ˆå¹³å‡å®¢å•ä»·å¯¹æ¯” - åŸºäºæ€§åˆ«ï¼‰
    const genderChart = echarts.init(document.getElementById('genderComparison'));
    genderChart.setOption({
        tooltip: { trigger: 'axis' },
        legend: { data: ['ç”·æ€§', 'å¥³æ€§', 'æœªçŸ¥'], top: 0 },
        xAxis: { type: 'category', data: genderComparisonData.categories },
        yAxis: { type: 'value', name: 'å¹³å‡æ¶ˆè´¹é‡‘é¢(å…ƒ)' },
        series: [
            {
                name: 'ç”·æ€§',
                type: 'bar',
                data: genderComparisonData.male,
                itemStyle: { color: '#1890ff', borderRadius: [6, 6, 0, 0] },
                label: { show: true, position: 'top', formatter: 'Â¥{c}' }
            },
            {
                name: 'å¥³æ€§',
                type: 'bar',
                data: genderComparisonData.female,
                itemStyle: { color: '#eb2f96', borderRadius: [6, 6, 0, 0] },
                label: { show: true, position: 'top', formatter: 'Â¥{c}' }
            },
            {
                name: 'æœªçŸ¥',
                type: 'bar',
                data: genderComparisonData.unknown,
                itemStyle: { color: '#d9d9d9', borderRadius: [6, 6, 0, 0] },
                label: { show: true, position: 'top', formatter: 'Â¥{c}' }
            }
        ]
    });
    
    // 5. å„å±‚ç”¨æˆ·è¡Œä¸ºè¦†ç›–ç‡ï¼ˆç”¨æˆ·å£å¾„ï¼‰
    const clickCoverageName = '30å¤©æœ‰ç‚¹å‡»ç”¨æˆ·å æ¯”(%)';
    const orderCoverageName = '30å¤©æœ‰ä¸‹å•ç”¨æˆ·å æ¯”(%)';
    const conversionChart = echarts.init(document.getElementById('segmentConversion'));
    conversionChart.setOption({
        tooltip: { trigger: 'axis' },
        legend: { data: [clickCoverageName, orderCoverageName], top: 0 },
        xAxis: { type: 'category', data: segmentConversionData.categories },
        yAxis: { type: 'value', name: 'ç™¾åˆ†æ¯”(%)', max: 100 },
        series: [
            {
                name: clickCoverageName,
                type: 'bar',
                data: segmentConversionData.click_rate,
                itemStyle: { color: '#1890ff', borderRadius: [6, 6, 0, 0] },
                label: { show: true, position: 'top', formatter: '{c}%' }
            },
            {
                name: orderCoverageName,
                type: 'bar',
                data: segmentConversionData.conversion_rate,
                itemStyle: { color: '#52c41a', borderRadius: [6, 6, 0, 0] },
                label: { show: true, position: 'top', formatter: '{c}%' }
            }
        ]
    });
    
    // 6. 24å°æ—¶è¶‹åŠ¿å›¾ï¼ˆ5ä¸ªç”¨æˆ·ç­‰çº§ï¼‰
    const segmentNames = {
        super_vip: 'ğŸ‘‘ è¶…çº§VIPç”¨æˆ·',
        potential: 'â­ æ½œåŠ›ä¼˜è´¨ç”¨æˆ·',
        active: 'ğŸ”¥ å¤§ä¼—æ´»è·ƒç”¨æˆ·',
        normal: 'ğŸ“¦ ä¸€èˆ¬ç”¨æˆ·',
        churn: 'âš ï¸ æµå¤±é£é™©ç”¨æˆ·'
    };
    
    const hourlyCharts = {};
    ['super_vip', 'potential', 'active', 'normal', 'churn'].forEach(segment => {
        const chartEl = document.getElementById('hourlyTrend_' + segment);
        if (!chartEl) return;
        
        const data = hourlyBySegmentData[segment] || { hours: [], clicks: [], orders: [] };
        const chart = echarts.init(chartEl);
        hourlyCharts[segment] = chart;
        
        chart.setOption({
            title: { text: segmentNames[segment] + ' - 24å°æ—¶è¶‹åŠ¿', left: 'center', top: 0, textStyle: { fontSize: 14, color: '#666' } },
            tooltip: { trigger: 'axis' },
            legend: { data: ['ç‚¹å‡»é‡', 'ä¸‹å•é‡'], top: 25 },
            grid: { left: 60, right: 60, bottom: 30, top: 70 },
            xAxis: { 
                type: 'category', 
                data: data.hours.map(h => h + ':00'),
                axisLabel: { fontSize: 10 }
            },
            yAxis: { type: 'value', name: 'æ•°é‡' },
            series: [
                {
                    name: 'ç‚¹å‡»é‡',
                    type: 'line',
                    data: data.clicks,
                    smooth: true,
                    lineStyle: { width: 3, color: '#1890ff' },
                    areaStyle: { 
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(24,144,255,0.4)' },
                            { offset: 1, color: 'rgba(24,144,255,0.1)' }
                        ])
                    }
                },
                {
                    name: 'ä¸‹å•é‡',
                    type: 'line',
                    data: data.orders,
                    smooth: true,
                    lineStyle: { width: 3, color: '#52c41a' },
                    areaStyle: { 
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(82,196,26,0.4)' },
                            { offset: 1, color: 'rgba(82,196,26,0.1)' }
                        ])
                    }
                }
            ]
        });
    });
    
    // 7. å·¥ä½œæ—¥éå·¥ä½œæ—¥å¯¹æ¯”
    const weekChart = echarts.init(document.getElementById('weekdayComparison'));
    weekChart.setOption({
        tooltip: { trigger: 'axis' },
        legend: { data: ['å·¥ä½œæ—¥', 'éå·¥ä½œæ—¥'], top: 0 },
        xAxis: { type: 'category', data: weekdayData.metrics },
        yAxis: { type: 'value', name: 'æ•°é‡' },
        series: [
            {
                name: 'å·¥ä½œæ—¥',
                type: 'bar',
                data: weekdayData.weekday,
                itemStyle: { color: '#1890ff', borderRadius: [6, 6, 0, 0] },
                label: { show: true, position: 'top' }
            },
            {
                name: 'éå·¥ä½œæ—¥',
                type: 'bar',
                data: weekdayData.weekend,
                itemStyle: { color: '#52c41a', borderRadius: [6, 6, 0, 0] },
                label: { show: true, position: 'top' }
            }
        ]
    });
    
    // Store charts for resize
    window.allCharts = [segmentChart, valueChart, vipChart, genderChart, conversionChart, weekChart, ...Object.values(hourlyCharts)];
    
    window.addEventListener('resize', () => {
        window.allCharts.forEach(chart => chart && chart.resize());
    });
}

// Tab switching for hourly segment charts
function initTabSwitching() {
    const tabs = document.querySelectorAll('.segment-tab');
    const charts = document.querySelectorAll('.hourly-segment-chart');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const segment = tab.dataset.segment;
            
            // Update tab styles
            tabs.forEach(t => {
                t.style.background = 'white';
                t.style.color = 'var(--primary-color)';
                t.classList.remove('active');
            });
            tab.style.background = 'var(--primary-color)';
            tab.style.color = 'white';
            tab.classList.add('active');
            
            // Show/hide charts
            charts.forEach(c => {
                c.style.display = 'none';
            });
            const activeChart = document.getElementById('hourlyTrend_' + segment);
            if (activeChart) {
                activeChart.style.display = 'block';
                // Trigger resize to fix chart rendering
                const chartInstance = echarts.getInstanceByDom(activeChart);
                if (chartInstance) chartInstance.resize();
            }
        });
    });
}

// ========== æ˜ç»†è¡¨æ¸²æŸ“ ==========
function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    summaryTableData.forEach(row => {
        if (!row || typeof row !== 'object') return;

        const dimension = String(
            row.dimension ?? row['ç»´åº¦'] ?? row.analysis_dimension ?? ''
        ).trim();
        const metric = String(
            row.metric ?? row['æŒ‡æ ‡åç§°'] ?? row.name ?? ''
        ).trim();
        const value = row.value ?? row['æ•°å€¼'] ?? '--';
        const compare = row.compare ?? row['å¯¹æ¯”åŸºå‡†'] ?? row['å æ¯”åŒæ¯”'] ?? row.compare_label ?? 'æš‚æ— å¯æ¯”åŸºå‡†';
        const rating = String(row.rating ?? row.level ?? '').trim();

        // åˆ é™¤â€œå•†å“åˆ†æâ€ç»´åº¦ï¼Œå…¼å®¹æ—§æ•°æ®å¯èƒ½ç¼ºå°‘dimensionçš„æƒ…å†µ
        if (dimension === 'å•†å“åˆ†æ') return;
        if (metric === 'TOP30å•†å“ç‚¹å‡»å æ¯”' || metric === 'å¿«é¤ç®€é¤ç±»å æ¯”') return;

        const tr = document.createElement('tr');
        
        let ratingTag = '-';
        if (rating === 'é«˜') ratingTag = '<span class="tag tag-high">ä¼˜ç§€</span>';
        else if (rating === 'ä¸­') ratingTag = '<span class="tag tag-medium">è‰¯å¥½</span>';
        else if (rating === 'ä½') ratingTag = '<span class="tag tag-low">å¾…ä¼˜åŒ–</span>';
        
        tr.innerHTML = `
            <td>${dimension || '-'}</td>
            <td style="text-align: left; padding-left: 1.5rem;">${metric || '-'}</td>
            <td><strong>${value}</strong></td>
            <td>${compare || 'æš‚æ— å¯æ¯”åŸºå‡†'}</td>
            <td>${ratingTag}</td>
        `;
        tbody.appendChild(tr);
    });
}

// ========== æ ·ä¾‹æ•°æ®æ¸²æŸ“ ==========
function renderSampleData() {
    const headRow = document.getElementById('sampleDataHeadRow');
    const tbody = document.getElementById('sampleDataBody');
    headRow.innerHTML = '';
    tbody.innerHTML = '';

    const headers = Array.isArray(sampleTableData.headers) ? sampleTableData.headers : [];
    const rows = Array.isArray(sampleTableData.rows) ? sampleTableData.rows : [];

    if (headers.length === 0 || rows.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 1;
        td.textContent = 'æš‚æ— æ ·ä¾‹æ•°æ®';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    headers.forEach((header) => {
        const th = document.createElement('th');
        th.textContent = header;
        headRow.appendChild(th);
    });

    rows.forEach((row) => {
        const tr = document.createElement('tr');

        headers.forEach((_, idx) => {
            const td = document.createElement('td');
            const value = Array.isArray(row) ? row[idx] : '';
            const text = value === null || value === undefined ? '' : String(value);
            td.textContent = text;
            if (text.length > 120) {
                td.title = text;
            }
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });
}

// ========== åˆå§‹åŒ– ==========
window.addEventListener('DOMContentLoaded', () => {
    const bootstrap = window.__DASHBOARD_BOOTSTRAP__;
    if (typeof bootstrap === 'function') {
        bootstrap();
        return;
    }

    initCharts();
    initTabSwitching();
    renderTable();
    renderSampleData();
});
</script>

</body>
</html>
