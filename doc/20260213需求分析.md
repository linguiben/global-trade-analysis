# GTA（Global Trade Analysis）— 2026-02-13 需求分析与实施计划

> 目标：把 GTA dashboard 从“可展示”升级为“可解释、可追溯、可探索（Top N + 排名 + 可切换图表 + 更可信 commentary）”的研究型看板。

## 0. 背景与现状（基于当前代码结构的理解）

- 前端：单页 dashboard（`app/web/templates/dashboard.html`），Chart.js 渲染。
- 后端：FastAPI + Jobs（定时作业）先抓取数据、落库，再由页面/API读取展示（降低前端直接调用外部 API）。
- 当前模块：
  - **Global Trade Flow**：corridors / exim / balance / freight / portwatch
  - **Global Wealth Distribution**：gdp pc / disposable pc / disposable hh / consumption（其中 disposable 数据源在演进）
  - **Global Financial Flow**：M&A by industry / by country

> 备注：本文档侧重产品/数据/研发方案，具体代码文件与函数名将在实施阶段补齐。

---

## 1. 需求列表（按你提供的 4 点拆解）

### R1. 增加「Global Trade Roadmap / 叙事主线」
**原始需求**：add roadmap for global trade, such as highline China?

**目标**：让用户在首页/Trade 模块看到“当下最重要的宏观主线”，而不是只看到散点指标。

**建议落地形态**（优先级从高到低）：
1) **Roadmap 卡片（顶部一张）**：
   - 标题：Global Trade Roadmap
   - 3–6 条 bullet：例如「China rebalancing」「US election / tariff risk」「Red Sea / canal reroute」「EM demand cycle」等
   - 每条 bullet 必须带：一句话结论 + 数据/来源链接（publication）
2) **高亮主题筛选（highlight China）**：
   - 点击主题后：Trade Flow 的 commentary 与重点指标切换为该主题视角（轻量版可只切换文字与链接）

**验收标准**：
- 用户打开页面 5 秒内能读到“今天 global trade 的 3-5 个关键叙事”；每条叙事能点开来源。

---

### R2. 各模块清晰标注数据来源与口径
**原始需求**：clarify the sources in each category

**目标**：任何图表/指标都能回答：
- 来源是谁（组织/报告/表格）
- 口径是什么（定义、单位、频率、是否代理指标）
- 更新时间/取数时间
- 数据链路（外部→作业→DB→展示）

**建议落地**：
- 每个 tab 下方统一一个 **“Source & Definition”** 区块：
  - Source（链接）
  - Definition（2–3 行）
  - Unit / Frequency / Last updated
  - Caveats（如：proxy/估算/缺失处理）
- 代码层面：在 job snapshot 元数据里固定字段（source, link, unit, frequency, note, publication_ref）。

**验收标准**：
- 任意一个指标，页面可见来源与定义；数据源变化不需要改前端结构（只改元数据）。

---

### R3. 图表形态调整：Wealth ring；Financial Flow bar 或用户可切换
**原始需求**：
- (Global Wealth Distribution) ring chart
- (Global Financial Flow) -> bar chat or self-select by user

**目标**：
- Wealth：对“结构占比/构成”用 ring 合理；对“时间序列/排名”用 bar/line 更合理。
- Financial Flow：用户有偏好（ring 更直观占比；bar 更利于比较）。

**建议落地（产品规则）**：
- **Wealth**：
  - 保留现有 GDP pc / Consumption 5Y line
  - 新增一个 **“Wealth ranking (Top N)”**：用 bar（或水平 bar）
  - ring 仅用于“构成/份额”类数据（如有），否则会误导
- **Financial Flow（M&A）**：
  - 默认：bar（更利于比较）
  - 提供切换：Bar ↔ Ring（同一数据源，同一 Top N）
  - 切换只影响前端渲染，不改变后端数据结构

**验收标准**：
- Financial Flow 可切换图表类型；Wealth 模块的 ring 不牺牲可比性（如 ring 使用需明确语义）。

---

### R4. Trade Flow / Wealth：增加 Ranking 与 Top N 可选
**原始需求**：
- (Global Trade Flow, Global Wealth Distribution) add ranking and select top N

**目标**：让用户在同一模块内完成探索：
- 看 Top corridor / Top countries
- 手动调整 Top N（5/10/20）
- 可选择指标口径（value/volume；pc/hh 等）

**建议落地**：
- UI 增加：Top N 下拉（5/10/20，默认 10）
- 后端 job 存储：保存完整排名（至少 Top 20 或 Top 50），前端按 Top N 截取显示
- Trade Flow：Corridors ranking（value/volume）
- Wealth：Ranking（GDP pc / disposable proxy / consumption 等）

**验收标准**：
- Top N 改动无需重新抓外部数据（只影响前端展示）
- 排名列表带单位与时间点

---

### R5. 深度研究 Commentary，并引用 publication
**原始需求**：deep research for Commentary and refer the publication

**目标**：commentary 从“自动生成一句话”升级为“像 research note”，且可追溯引用。

**建议落地**：
- 每个模块（或每个 tab）commentary 输出结构固定：
  1) What happened（发生了什么，基于数据）
  2) Why it matters（为什么重要）
  3) What to watch next（下一步观察点）
  4) References（publication 列表，至少 1–3 条）
- 数据层：job snapshot 元数据中增加 `references: [{title,url,publisher,date}]`
- 生成方式：
  - Phase 1：手工 curated（先保证质量）
  - Phase 2：半自动（爬取 publication 摘要 + LLM 生成 + 人审）

**验收标准**：
- 每个 commentary 至少 1 条 publication 引用；内容不出现“无依据推断”。

---

## 2. 关键决策与待澄清问题（Open Questions）

为避免做错方向，需要你确认/选择：
1) **Roadmap 主题列表**：是否固定 5 个主题？是否需要「highlight China」为默认？
2) **Top N 的最大值**：前端最多给 20 还是 50？（影响 DB 存储与渲染性能）
3) **Wealth ring 的语义**：你想 ring 表达“哪个维度的份额/构成”？（例如：按 region share、按 income group share）若无明确 share 语义，不建议强上 ring。
4) **Commentary 的更新频率**：随每次 job 更新自动更新，还是每周/每月更新一次（更像研报）？

---

## 3. 实施计划（分阶段、可交付）

### Phase 0（0.5 天）：信息盘点与数据字典
- 产出：`/doc/data_dictionary.md`（或直接并入本需求文档）
- 内容：每个 widget/tab 的字段、单位、来源、抓取方式、落库表、更新频率

### Phase 1（1–2 天）：来源标注 + Top N UI（不改外部数据源）
- 前端：
  - 每个 tab 增加统一 Source&Definition 区块（读 snapshot 元数据）
  - 加 Top N 控件（5/10/20），用于 ranking 展示截取
- 后端：
  - 确保 snapshots 元数据字段齐全（source/link/unit/frequency/note/references[]）

### Phase 2（2–4 天）：Ranking 落地（Trade + Wealth）
- Trade corridors：存储并展示 Top corridors 列表（value/volume）
- Wealth：实现 1–2 个可用 ranking（例如 GDP pc / consumption）
- DB：增加对应 snapshot key 或表结构（尽量复用现有 snapshot 模型）

### Phase 3（2–4 天）：图表切换与可视化优化
- Financial Flow：bar ↔ ring 切换（同一数据）
- Wealth：若确认 ring 语义，新增 ring；否则用 bar/line + ranking

### Phase 4（持续迭代）：Commentary 深度化（publication 引用）
- 建立 references 采集机制（先手工 curated）
- 形成 commentary 模板与质量标准

---

## 4. 技术实现要点（高层设计）

### 4.1 数据层
- 统一 snapshot schema：
  - `key / geo / period / rows|series / source / link / unit / frequency / updated_at / note / references[]`
- Ranking：建议 snapshot 存 Top50（或 Top20）列表，前端按 Top N 截取。

### 4.2 前端层
- 统一组件化（即便仍在单 HTML 内）：
  - Source block renderer
  - TopN selector
  - Chart type selector（bar/ring）

### 4.3 Commentary
- 以 publication 为中心：先存引用，再写 commentary。
- 任何自动生成都必须带引用；没有引用则降级为“数据解读（仅基于本数据）”。

---

## 5. 交付物清单

- `/doc/20260213需求分析.md`（本文）
- （后续）`/doc/data_dictionary.md`
- 代码：
  - Frontend：TopN/Source/Chart switch
  - Backend：ranking snapshots、references 字段
  - Jobs：commentary pipeline（可选）

---

## 6. 下一步（需要你一句话确认）

请你确认 3 个选择，我就按此开工：
1) Roadmap 默认是否「China 高亮」？（是/否）
2) Top N 允许的最大值：20 还是 50？
3) Wealth ring 具体想表达什么“份额/构成”？（给一个维度定义即可）
