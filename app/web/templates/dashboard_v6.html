<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Trade Analysis ¬∑ Dashboard v6</title>
  <link rel="icon" href="{{ base_path }}/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { -ms-overflow-style: none; scrollbar-width: none; }
    html::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
    body { background-color: #0f172a; color: #f8fafc; overflow: auto; -ms-overflow-style: none; }
    body::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
    .card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(51, 65, 85, 1); backdrop-filter: blur(8px); }

    /* Map land styling */
    .land { fill: rgba(148,163,184,.10); stroke: rgba(148,163,184,.15); stroke-width: 0.5; cursor: pointer; transition: fill 0.15s; }
    .land:hover { fill: rgba(148,163,184,.22); }
    .land.has-data { fill: rgba(148,163,184,.18); stroke: rgba(148,163,184,.25); stroke-width: 0.6; }
    .land.selected { fill: rgba(96,165,250,.25); stroke: rgba(96,165,250,.5); stroke-width: 1.2; }
    .land.dimmed { fill: rgba(148,163,184,.06); stroke: rgba(148,163,184,.10); }
    .graticule { fill: none; stroke: rgba(148,163,184,.08); stroke-width: 0.5; }

    /* Drawer */
    .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 45; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .drawer-overlay.open { opacity: 1; pointer-events: auto; }
    .drawer { position: fixed; top: 0; right: 0; width: 420px; max-width: 92vw; height: 100vh; z-index: 50;
              background: rgba(15, 23, 42, 0.97); backdrop-filter: blur(12px);
              border-left: 1px solid rgba(51, 65, 85, 0.8);
              transform: translateX(100%); transition: transform 0.3s ease;
              display: flex; flex-direction: column; }
    .drawer.open { transform: translateX(0); }
    .drawer-scroll { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: thin; scrollbar-color: rgba(148,163,184,0.4) rgba(15,23,42,0.35); }
    .drawer-scroll::-webkit-scrollbar { width: 6px; }
    .drawer-scroll::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.35); }
    .drawer-scroll::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.4); border-radius: 8px; }

    /* Drawer section card */
    .dsec { background: rgba(30,41,59,0.5); border: 1px solid rgba(51,65,85,0.6); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
    .dsec-title { font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
  </style>
</head>
<body class="p-4 md:p-8">
  {% set base = base_path or '' %}
  <div class="max-w-7xl mx-auto">

    <header class="mb-6 flex flex-wrap justify-between items-center gap-3">
      <div>
        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
          Global Trade Analysis <span class="text-xs font-mono align-top text-slate-300">v6</span>
        </h1>
        <p class="text-slate-400 text-sm mt-1" style="font-family: cursive;">$POC ¬∑ data-driven trade insights$</p>
      </div>
      <div class="text-right text-xs text-slate-500 font-mono">
        Visited: {{ visited_count }}<br>{{ now }}<br>
        Data Updated: {{ data_updated_at }}<br>
        Stale: {% if data_is_stale %}YES{% else %}NO{% endif %}
      </div>
      <nav class="w-full text-right text-xs text-slate-400 space-x-3">
        <a class="hover:text-blue-300" href="{{ base }}/">v1</a>
        <a class="hover:text-blue-300" href="{{ base }}/v2">v2</a>
        <a class="hover:text-blue-300" href="{{ base }}/v3">v3</a>
        <a class="hover:text-blue-300" href="{{ base }}/v4">v4</a>
        <a class="hover:text-blue-300" href="{{ base }}/v5">v5</a>
        <a class="text-blue-300 font-semibold" href="{{ base }}/v6">v6</a>
        <span class="text-slate-600">|</span>
        <a class="hover:text-blue-300" href="{{ base }}/map/trade-flow">Map</a>
        <a class="hover:text-blue-300" href="{{ base }}/health">Health</a>
        <a class="hover:text-blue-300" href="{{ base }}/jobs">Jobs</a>
      </nav>
    </header>

        <section class="card rounded-3xl p-6 md:p-8 mb-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <h2 class="text-xl md:text-2xl font-bold text-slate-100">Executive Brief</h2>
        <div class="text-xs text-slate-500 font-mono">Auto-generated from latest data</div>
      </div>
      <div class="mt-4">
        <div id="exec_summary" class="rounded-2xl bg-slate-900/40 border border-slate-700/60 p-4 text-sm leading-relaxed text-slate-200">
          Loading executive summary&hellip;
        </div>
      </div>
    </section>

        <div id="kpi_bar" class="sticky top-0 z-40 grid grid-cols-2 md:grid-cols-5 gap-2 mb-4 py-2 px-1 rounded-2xl" style="background: rgba(15,23,42,0.92); backdrop-filter: blur(8px);"></div>

        <section class="card rounded-3xl p-3 md:p-4 relative overflow-hidden mb-4">
      <div class="flex items-center justify-between px-2 pt-1 pb-2">
        <div>
          <div class="text-xs text-slate-400 font-mono">Interactive Map</div>
          <div class="text-sm text-slate-300 mt-0.5">Click any country to explore trade &amp; wealth data</div>
        </div>
        <div class="flex items-center gap-3 text-[11px] text-slate-500 font-mono">
          <span class="inline-flex items-center gap-1"><span style="width:8px;height:8px;border-radius:50%;background:rgba(148,163,184,.18);border:1px solid rgba(148,163,184,.35);display:inline-block;"></span> Has data</span>
          <span class="inline-flex items-center gap-1"><span style="width:8px;height:8px;border-radius:50%;background:rgba(148,163,184,.06);border:1px solid rgba(148,163,184,.12);display:inline-block;"></span> No data</span>
          <span class="inline-flex items-center gap-1"><span style="width:8px;height:8px;border-radius:50%;background:rgba(96,165,250,.25);border:1px solid rgba(96,165,250,.5);display:inline-block;"></span> Selected</span>
        </div>
      </div>
      <div id="mapContainer" class="relative" style="height: 65vh; min-height: 480px;">
        <svg id="mapSvg" style="width:100%;height:100%;" aria-label="World map"></svg>
        <div id="mapHud" class="absolute left-3 top-3 card rounded-xl px-3 py-2 font-mono text-[11px] text-slate-300/90">
          <div id="hudLine">Loading map&hellip;</div>
        </div>
      </div>
    </section>

        <section class="card rounded-3xl p-6 mb-4">
      <h3 class="text-lg font-bold">Notes</h3>
      <ul class="mt-3 text-sm text-slate-400 space-y-2 list-disc pl-5">
        <li>Click a country on the map to see its trade, wealth, and demographic data in the side panel.</li>
        <li>Countries with available data are shaded brighter; dimmed countries have no tracked data yet.</li>
        <li>All data sourced from scheduled DB snapshots ‚Äî no live external calls.</li>
      </ul>
    </section>

    <footer class="mt-8 text-xs text-slate-600">
      Global Trade Analysis &middot; GTA &middot; {{ now }}
    </footer>
  </div>

    <div id="drawerOverlay" class="drawer-overlay"></div>

    <div id="drawer" class="drawer">
    <div class="flex items-center justify-between px-5 py-4 border-b border-slate-700/60">
      <div>
        <div id="drawer_geo_name" class="text-lg font-bold text-slate-100">‚Äî</div>
        <div id="drawer_geo_sub" class="text-xs text-slate-500 font-mono mt-0.5"></div>
      </div>
      <button id="drawerClose" class="text-slate-400 hover:text-slate-200 transition-colors p-1" aria-label="Close panel">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="4" x2="16" y2="16"/><line x1="16" y1="4" x2="4" y2="16"/></svg>
      </button>
    </div>
    <div id="drawerBody" class="drawer-scroll">
      <!-- dynamic content injected here -->
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>

  <script>
    const BASE = "{{ base }}";
    const DASHBOARD_DATA = {{ dashboard_data | tojson }};

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HELPERS (ported from v3)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    function fmtUSD(n) {
      if (n == null) return '‚Äî';
      const abs = Math.abs(n);
      if (abs >= 1e12) return (n/1e12).toFixed(2) + 'T';
      if (abs >= 1e9) return (n/1e9).toFixed(2) + 'B';
      if (abs >= 1e6) return (n/1e6).toFixed(2) + 'M';
      return String(n);
    }

    function fmtSignedUSD(n) {
      if (n == null) return '‚Äî';
      const sign = n >= 0 ? '+' : '‚àí';
      return sign + '$' + fmtUSD(Math.abs(n));
    }

    function _safeNum(x) {
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function _lastTwoPoints(series, field) {
      const s = (series || []).filter(r => r && r[field] != null);
      if (s.length < 2) return [null, null];
      return [_safeNum(s[s.length - 2][field]), _safeNum(s[s.length - 1][field])];
    }

    function _yoyPct(series, field) {
      const [prev, last] = _lastTwoPoints(series, field);
      if (prev == null || last == null || prev === 0) return null;
      return ((last - prev) / Math.abs(prev)) * 100.0;
    }

    function _fmtPct(p) {
      if (p == null) return '‚Äî';
      const sign = p >= 0 ? '+' : '‚àí';
      return sign + Math.abs(p).toFixed(1) + '%';
    }

    function _pill(label, value, tone) {
      const tones = {
        blue:    'border-blue-500/40 bg-blue-500/10 text-blue-200',
        emerald: 'border-emerald-500/40 bg-emerald-500/10 text-emerald-200',
        fuchsia: 'border-fuchsia-500/40 bg-fuchsia-500/10 text-fuchsia-200',
        amber:   'border-amber-500/40 bg-amber-500/10 text-amber-200',
        slate:   'border-slate-600/60 bg-slate-900/30 text-slate-200',
      };
      const cls = tones[tone] || tones.slate;
      return `<div class="rounded-xl border ${cls} px-3 py-2">
        <div class="text-[10px] opacity-80">${label}</div>
        <div class="text-sm font-semibold mt-0.5">${value}</div>
      </div>`;
    }

    function _fmtSourceUpdated(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return String(iso);
        return d.toISOString().replace('T',' ').replace('.000Z',' UTC');
      } catch { return String(iso); }
    }

    function _getInsight(card, tab, scope) {
      const m = (DASHBOARD_DATA.insights || {});
      return (((m[card] || {})[tab] || {})[scope] || null);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ISO NUMERIC ‚Üí ALPHA-2 LOOKUP
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    const ISO_NUM = {
      '4':'AF','8':'AL','12':'DZ','24':'AO','32':'AR','36':'AU','40':'AT','50':'BD',
      '56':'BE','64':'BT','68':'BO','70':'BA','72':'BW','76':'BR','100':'BG','104':'MM',
      '108':'BI','116':'KH','120':'CM','124':'CA','140':'CF','144':'LK','148':'TD','152':'CL',
      '156':'CN','170':'CO','178':'CG','180':'CD','188':'CR','191':'HR','192':'CU','196':'CY',
      '203':'CZ','204':'BJ','208':'DK','214':'DO','218':'EC','818':'EG','222':'SV','226':'GQ',
      '232':'ER','233':'EE','231':'ET','242':'FJ','246':'FI','250':'FR','266':'GA','270':'GM',
      '268':'GE','276':'DE','288':'GH','300':'GR','320':'GT','324':'GN','328':'GY','332':'HT',
      '340':'HN','344':'HK','348':'HU','352':'IS','356':'IN','360':'ID','364':'IR','368':'IQ',
      '372':'IE','376':'IL','380':'IT','384':'CI','388':'JM','392':'JP','400':'JO','398':'KZ',
      '404':'KE','410':'KR','414':'KW','418':'LA','422':'LB','426':'LS','430':'LR','434':'LY',
      '440':'LT','442':'LU','450':'MG','454':'MW','458':'MY','466':'ML','478':'MR','484':'MX',
      '496':'MN','504':'MA','508':'MZ','516':'NA','524':'NP','528':'NL','540':'NC','554':'NZ',
      '558':'NI','562':'NE','566':'NG','578':'NO','512':'OM','586':'PK','591':'PA','598':'PG',
      '600':'PY','604':'PE','608':'PH','616':'PL','620':'PT','630':'PR','634':'QA','642':'RO',
      '643':'RU','646':'RW','682':'SA','686':'SN','688':'RS','694':'SL','702':'SG','703':'SK',
      '704':'VN','705':'SI','706':'SO','710':'ZA','716':'ZW','724':'ES','736':'SD','740':'SR',
      '752':'SE','756':'CH','760':'SY','762':'TJ','764':'TH','768':'TG','780':'TT','788':'TN',
      '792':'TR','795':'TM','800':'UG','804':'UA','784':'AE','826':'GB','834':'TZ','840':'US',
      '858':'UY','860':'UZ','862':'VE','887':'YE','894':'ZM','158':'TW'
    };

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       GEO NAME MAPPING  (ISO alpha-2 ‚Üî DASHBOARD_DATA geo names)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    const ISO_TO_GEO = {
      'AF':'Afghanistan','AL':'Albania','DZ':'Algeria','AO':'Angola','AR':'Argentina',
      'AU':'Australia','AT':'Austria','BD':'Bangladesh','BE':'Belgium','BT':'Bhutan',
      'BO':'Bolivia','BA':'Bosnia and Herzegovina','BW':'Botswana','BR':'Brazil','BG':'Bulgaria',
      'MM':'Myanmar','BI':'Burundi','KH':'Cambodia','CM':'Cameroon','CA':'Canada',
      'CF':'Central African Republic','LK':'Sri Lanka','TD':'Chad','CL':'Chile','CN':'China',
      'CO':'Colombia','CG':'Republic of Congo','CD':'Democratic Republic of the Congo',
      'CR':'Costa Rica','HR':'Croatia','CU':'Cuba','CY':'Cyprus','CZ':'Czech Republic',
      'BJ':'Benin','DK':'Denmark','DO':'Dominican Republic','EC':'Ecuador','EG':'Egypt',
      'SV':'El Salvador','GQ':'Equatorial Guinea','ER':'Eritrea','EE':'Estonia','ET':'Ethiopia',
      'FJ':'Fiji','FI':'Finland','FR':'France','GA':'Gabon','GM':'Gambia','GE':'Georgia',
      'DE':'Germany','GH':'Ghana','GR':'Greece','GT':'Guatemala','GN':'Guinea','GY':'Guyana',
      'HT':'Haiti','HN':'Honduras','HK':'Hong Kong','HU':'Hungary','IS':'Iceland','IN':'India',
      'ID':'Indonesia','IR':'Iran','IQ':'Iraq','IE':'Ireland','IL':'Israel','IT':'Italy',
      'CI':'Ivory Coast','JM':'Jamaica','JP':'Japan','JO':'Jordan','KZ':'Kazakhstan',
      'KE':'Kenya','KR':'South Korea','KW':'Kuwait','LA':'Laos','LB':'Lebanon','LS':'Lesotho',
      'LR':'Liberia','LY':'Libya','LT':'Lithuania','LU':'Luxembourg','MG':'Madagascar',
      'MW':'Malawi','MY':'Malaysia','ML':'Mali','MR':'Mauritania','MX':'Mexico','MN':'Mongolia',
      'MA':'Morocco','MZ':'Mozambique','NA':'Namibia','NP':'Nepal','NL':'Netherlands',
      'NC':'New Caledonia','NZ':'New Zealand','NI':'Nicaragua','NE':'Niger','NG':'Nigeria',
      'NO':'Norway','OM':'Oman','PK':'Pakistan','PA':'Panama','PG':'Papua New Guinea',
      'PY':'Paraguay','PE':'Peru','PH':'Philippines','PL':'Poland','PT':'Portugal',
      'PR':'Puerto Rico','QA':'Qatar','RO':'Romania','RU':'Russia','RW':'Rwanda',
      'SA':'Saudi Arabia','SN':'Senegal','RS':'Serbia','SL':'Sierra Leone','SG':'Singapore',
      'SK':'Slovakia','VN':'Vietnam','SI':'Slovenia','SO':'Somalia','ZA':'South Africa',
      'ZW':'Zimbabwe','ES':'Spain','SD':'Sudan','SR':'Suriname','SE':'Sweden','CH':'Switzerland',
      'SY':'Syria','TJ':'Tajikistan','TH':'Thailand','TG':'Togo','TT':'Trinidad and Tobago',
      'TN':'Tunisia','TR':'Turkey','TM':'Turkmenistan','UG':'Uganda','UA':'Ukraine',
      'AE':'United Arab Emirates','GB':'United Kingdom','TZ':'Tanzania','US':'United States',
      'UY':'Uruguay','UZ':'Uzbekistan','VE':'Venezuela','YE':'Yemen','ZM':'Zambia','TW':'Taiwan'
    };

    /* Build reverse index: geo name (as it appears in DASHBOARD_DATA) ‚Üí ISO alpha-2 */
    const geoDataIndex = {};   // geo name ‚Üí { trade, exim, wealth, age, disp }
    const dataGeoSet = new Set(); // all geo names that have ANY data

    function buildGeoIndex() {
      const tc  = DASHBOARD_DATA.trade_corridors || {};
      const geos = tc.geos || [];
      const byGeo = tc.by_geo || {};
      const exim = DASHBOARD_DATA.trade_exim_by_geo || {};
      const wealth = DASHBOARD_DATA.wealth_indicators_by_geo || {};
      const age = DASHBOARD_DATA.wealth_age_structure_by_geo || {};
      const disp = (DASHBOARD_DATA.wealth_disposable_latest || {}).rows || {};

      const allGeos = new Set([...geos, ...Object.keys(exim), ...Object.keys(wealth), ...Object.keys(age), ...Object.keys(disp)]);

      allGeos.forEach(g => {
        if (g === 'Global') return; // skip aggregate
        geoDataIndex[g] = {
          trade: byGeo[g] || null,
          exim: exim[g] || null,
          wealth: wealth[g] || null,
          age: age[g] || null,
          disp: disp[g] || null,
        };
        dataGeoSet.add(g);
      });

      // Also index Global
      geoDataIndex['Global'] = {
        trade: byGeo['Global'] || null,
        exim: exim['Global'] || null,
        wealth: wealth['Global'] || null,
        age: age['Global'] || null,
        disp: disp['Global'] || null,
      };
    }

    /* Resolve a geo name from ISO alpha-2 code ‚Äî tries exact match, then common variants */
    function resolveGeo(isoAlpha2) {
      if (!isoAlpha2) return null;
      // 1) Direct match in our data index
      const fullName = ISO_TO_GEO[isoAlpha2];
      if (fullName && geoDataIndex[fullName]) return fullName;
      // 2) Try ISO code itself (some datasets use "US", "IN", etc.)
      if (geoDataIndex[isoAlpha2]) return isoAlpha2;
      // 3) Try the full name even if no data
      return fullName || isoAlpha2;
    }

    function geoHasData(geoName) {
      return dataGeoSet.has(geoName);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       EXECUTIVE SUMMARY
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    function renderExecSummary() {
      const el = document.getElementById('exec_summary');
      if (!el) return;

      const tc = DASHBOARD_DATA.trade_corridors || {};
      const gl = (tc.by_geo || {}).Global || {};
      const wci = tc.wci || {};
      const expUsd = _safeNum(gl.export_usd);
      const impUsd = _safeNum(gl.import_usd);
      const bal = _safeNum(gl.trade_balance_usd);
      const wciVal = _safeNum(wci.value_usd_per_40ft);

      const globalExim = (DASHBOARD_DATA.trade_exim_by_geo || {}).Global || { series: [] };
      const yoyEx = _yoyPct(globalExim.series, 'export_usd');
      const yoyIm = _yoyPct(globalExim.series, 'import_usd');

      const globalWealth = (DASHBOARD_DATA.wealth_indicators_by_geo || {}).Global || { series: [] };
      const yoyGdp = _yoyPct(globalWealth.series, 'gdp_per_capita_usd');

      const maInd = DASHBOARD_DATA.finance_ma_industry || { rows: [] };
      const top10 = (maInd.rows || []).slice(0, 10);
      const totalDeals = top10.reduce((a, r) => a + Number(r.deals || 0), 0);
      const totalValBn = top10.reduce((a, r) => a + Number(r.value_usd_bil || 0), 0);

      const parts = [];

      // Trade
      if (expUsd != null && impUsd != null) {
        let tradeSentence = `Global trade is running at $${fmtUSD(expUsd)} in exports and $${fmtUSD(impUsd)} in imports`;
        if (yoyEx != null && yoyIm != null) {
          tradeSentence += ` (exports ${_fmtPct(yoyEx)} YoY, imports ${_fmtPct(yoyIm)} YoY)`;
        }
        tradeSentence += '.';
        parts.push(tradeSentence);
      }

      // Balance
      if (bal != null) {
        const dir = bal >= 0 ? 'surplus' : 'deficit';
        parts.push(`The global trade balance stands at a $${fmtUSD(Math.abs(bal))} ${dir}.`);
      }

      // WCI
      if (wciVal != null) {
        parts.push(`Freight costs (Drewry WCI) are at $${wciVal.toLocaleString()}/40ft container ‚Äî <strong class="font-semibold text-slate-50">elevated levels that warrant monitoring for margin compression and supply-chain impacts</strong>.`);
      }

      // GDP
      if (yoyGdp != null) {
        parts.push(`GDP per capita is trending ${_fmtPct(yoyGdp)} YoY across tracked economies.`);
      }

      // M&A
      if (totalDeals > 0) {
        parts.push(`M&A activity shows ${totalDeals.toLocaleString()} top-sector deals totaling $${totalValBn.toFixed(1)}B ‚Äî watch for rotation in where deal value concentrates.`);
      }

      el.innerHTML = parts.length ? parts.join(' ') : 'Awaiting data from scheduled snapshots.';
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       KPI BAR
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    function renderKPIBar() {
      const bar = document.getElementById('kpi_bar');
      if (!bar) return;

      const tc = DASHBOARD_DATA.trade_corridors || {};
      const gl = (tc.by_geo || {}).Global || {};
      const wci = tc.wci || {};
      const expUsd = _safeNum(gl.export_usd);
      const impUsd = _safeNum(gl.import_usd);
      const bal = _safeNum(gl.trade_balance_usd);
      const wciVal = _safeNum(wci.value_usd_per_40ft);
      const wciLine = wciVal != null ? ('$' + wciVal.toLocaleString() + '/40ft') : '‚Äî';
      const balTone = (bal != null && bal >= 0) ? 'amber' : 'fuchsia';

      const maInd = DASHBOARD_DATA.finance_ma_industry || { rows: [] };
      const top10 = (maInd.rows || []).slice(0, 10);
      const totalDeals = top10.reduce((a, r) => a + Number(r.deals || 0), 0);

      bar.innerHTML = [
        _pill('Global Exports', expUsd != null ? '$' + fmtUSD(expUsd) : '‚Äî', 'emerald'),
        _pill('Global Imports', impUsd != null ? '$' + fmtUSD(impUsd) : '‚Äî', 'blue'),
        _pill('Trade Balance', bal != null ? fmtSignedUSD(bal) : '‚Äî', balTone),
        _pill('Freight (WCI)', wciLine, 'fuchsia'),
        _pill('M&A Deals (top 10)', totalDeals ? totalDeals.toLocaleString() : '‚Äî', 'slate'),
      ].join('');
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MAP STATE & RENDERING
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    const mapState = {
      world: null,
      centroids: {},
      selectedIso: null,
      selectedGeo: null,
    };

    const drawerCharts = {};

    function destroyDrawerCharts() {
      Object.keys(drawerCharts).forEach(k => {
        if (drawerCharts[k]) { drawerCharts[k].destroy(); drawerCharts[k] = null; }
      });
    }

    function renderMap() {
      if (!mapState.world) return;
      const svg = d3.select('#mapSvg');
      svg.selectAll('*').remove();

      const { width, height } = svg.node().getBoundingClientRect();
      svg.attr('viewBox', `0 0 ${width} ${height}`);

      const projection = d3.geoNaturalEarth1()
        .translate([width / 2, height / 2])
        .scale(Math.min(width, height) * 0.33);

      const path = d3.geoPath(projection);
      const land = topojson.feature(mapState.world, mapState.world.objects.countries);

      // Graticule
      svg.append('path').attr('class', 'graticule').attr('d', path(d3.geoGraticule10()));

      // Land paths
      svg.append('g')
        .selectAll('path')
        .data(land.features)
        .join('path')
        .attr('class', d => {
          const iso = ISO_NUM[String(d.id)];
          const geo = iso ? resolveGeo(iso) : null;
          const hasData = geo && geoHasData(geo);

          if (mapState.selectedIso && iso === mapState.selectedIso) return 'land selected';
          if (hasData) return 'land has-data';
          return 'land dimmed';
        })
        .attr('d', path)
        .on('click', function(ev, d) {
          ev.stopPropagation();
          const iso = ISO_NUM[String(d.id)];
          if (!iso) return;

          const geo = resolveGeo(iso);
          if (mapState.selectedIso === iso) {
            // clicking same country again ‚Äî close drawer
            closeDrawer();
            return;
          }
          mapState.selectedIso = iso;
          mapState.selectedGeo = geo;
          renderMap(); // re-render to update highlight
          openDrawer(geo, iso);
        })
        .on('mouseenter', function(ev, d) {
          const iso = ISO_NUM[String(d.id)];
          if (!iso) return;
          const geo = resolveGeo(iso);
          document.getElementById('hudLine').textContent = `${geo || iso} ${geoHasData(geo) ? '¬∑ has data' : '¬∑ no data'}`;
        })
        .on('mouseleave', function() {
          const count = dataGeoSet.size;
          document.getElementById('hudLine').textContent = `${count} economies tracked ¬∑ click to explore`;
        });

      // Click SVG background to deselect
      svg.on('click', function(ev) {
        if (ev.target === svg.node()) {
          closeDrawer();
        }
      });

      // HUD
      document.getElementById('hudLine').textContent = `${dataGeoSet.size} economies tracked ¬∑ click to explore`;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       DRAWER LOGIC
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    function openDrawer(geoName, isoCode) {
      const drawer = document.getElementById('drawer');
      const overlay = document.getElementById('drawerOverlay');
      drawer.classList.add('open');
      overlay.classList.add('open');

      document.getElementById('drawer_geo_name').textContent = geoName || isoCode || '‚Äî';
      document.getElementById('drawer_geo_sub').textContent = isoCode ? `ISO: ${isoCode}` : '';

      renderDrawerContent(geoName);
    }

    function closeDrawer() {
      const drawer = document.getElementById('drawer');
      const overlay = document.getElementById('drawerOverlay');
      drawer.classList.remove('open');
      overlay.classList.remove('open');
      mapState.selectedIso = null;
      mapState.selectedGeo = null;
      destroyDrawerCharts();
      renderMap();
    }

    function renderDrawerContent(geoName) {
      const body = document.getElementById('drawerBody');
      destroyDrawerCharts();

      const data = geoDataIndex[geoName];
      if (!data || (!data.trade && !data.exim && !data.wealth && !data.age && !data.disp)) {
        body.innerHTML = `
          <div class="flex flex-col items-center justify-center py-16 text-center">
            <div class="text-4xl mb-4 opacity-30">üåê</div>
            <div class="text-slate-400 text-sm">No data available for <span class="text-slate-200 font-semibold">${geoName}</span></div>
            <div class="text-slate-500 text-xs mt-2">This economy is not yet tracked in our scheduled data snapshots.</div>
          </div>`;
        return;
      }

      let html = '';

      // ‚îÄ‚îÄ Section A: Trade Overview ‚îÄ‚îÄ
      const trade = data.trade;
      const exim = data.exim;
      if (trade || exim) {
        html += `<div class="dsec">
          <div class="dsec-title">Trade Overview</div>`;

        if (trade) {
          const exp = _safeNum(trade.export_usd);
          const imp = _safeNum(trade.import_usd);
          const bal = _safeNum(trade.trade_balance_usd);
          html += `
            <div class="grid grid-cols-3 gap-2 text-center mb-3">
              <div class="rounded-lg bg-slate-900/50 px-2 py-2">
                <div class="text-[10px] text-slate-500">Export</div>
                <div class="text-sm font-semibold text-blue-300">${exp != null ? '$' + fmtUSD(exp) : '‚Äî'}</div>
              </div>
              <div class="rounded-lg bg-slate-900/50 px-2 py-2">
                <div class="text-[10px] text-slate-500">Import</div>
                <div class="text-sm font-semibold text-emerald-300">${imp != null ? '$' + fmtUSD(imp) : '‚Äî'}</div>
              </div>
              <div class="rounded-lg bg-slate-900/50 px-2 py-2">
                <div class="text-[10px] text-slate-500">Balance</div>
                <div class="text-sm font-semibold ${bal != null && bal >= 0 ? 'text-amber-300' : 'text-pink-300'}">${bal != null ? fmtSignedUSD(bal) : '‚Äî'}</div>
              </div>
            </div>`;
        }

        if (exim && exim.series && exim.series.length > 0) {
          html += `<canvas id="drawer_exim_chart" height="160" class="mt-2"></canvas>
                   <div class="text-[10px] text-slate-500 font-mono mt-1">Source: ${exim.source || 'N/A'} ¬∑ ${exim.frequency || ''}</div>`;
        }

        html += `</div>`;
      }

      // ‚îÄ‚îÄ Section B: Top Corridors ‚îÄ‚îÄ
      if (trade && trade.value_usd_top && trade.value_usd_top.length > 0) {
        const corridors = trade.value_usd_top.slice(0, 5);
        html += `<div class="dsec">
          <div class="dsec-title">Top Corridors (Value)</div>
          <div class="space-y-1.5">`;
        corridors.forEach(c => {
          html += `<div class="flex items-center justify-between text-xs">
            <span class="text-slate-300">${c.origin} ‚Üí ${c.dest}</span>
            <span class="text-slate-400 font-mono">$${fmtUSD(c.value_usd)}</span>
          </div>`;
        });
        html += `</div></div>`;
      }

      // ‚îÄ‚îÄ Section C: Wealth Indicators ‚îÄ‚îÄ
      const wealth = data.wealth;
      if (wealth && wealth.series && wealth.series.length > 0) {
        const s = wealth.series;
        const lastGdp = s.filter(r => r.gdp_per_capita_usd != null);
        const lastCons = s.filter(r => r.consumption_expenditure_usd != null);
        const gdpVal = lastGdp.length ? lastGdp[lastGdp.length - 1].gdp_per_capita_usd : null;
        const consVal = lastCons.length ? lastCons[lastCons.length - 1].consumption_expenditure_usd : null;
        const yoyGdp = _yoyPct(s, 'gdp_per_capita_usd');
        const yoyCons = _yoyPct(s, 'consumption_expenditure_usd');

        html += `<div class="dsec">
          <div class="dsec-title">Wealth Indicators</div>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="rounded-lg bg-slate-900/50 px-2 py-2">
              <div class="text-[10px] text-slate-500">GDP per capita</div>
              <div class="text-sm font-semibold text-amber-300">${gdpVal != null ? '$' + Math.round(gdpVal).toLocaleString() : '‚Äî'}</div>
              <div class="text-[10px] text-slate-500">${_fmtPct(yoyGdp)} YoY</div>
            </div>
            <div class="rounded-lg bg-slate-900/50 px-2 py-2">
              <div class="text-[10px] text-slate-500">Consumption</div>
              <div class="text-sm font-semibold text-emerald-300">${consVal != null ? '$' + fmtUSD(consVal) : '‚Äî'}</div>
              <div class="text-[10px] text-slate-500">${_fmtPct(yoyCons)} YoY</div>
            </div>
          </div>
          <canvas id="drawer_wealth_chart" height="140"></canvas>
          <div class="text-[10px] text-slate-500 font-mono mt-1">Source: ${wealth.source || 'N/A'} ¬∑ ${wealth.frequency || ''}</div>
        </div>`;
      }

      // ‚îÄ‚îÄ Section D: Disposable Income ‚îÄ‚îÄ
      const disp = data.disp;
      if (disp) {
        const pc = disp.per_capita_usd != null ? '$' + Math.round(disp.per_capita_usd).toLocaleString() : '‚Äî';
        const hh = disp.per_household_usd != null ? '$' + Math.round(disp.per_household_usd).toLocaleString() : '‚Äî';
        html += `<div class="dsec">
          <div class="dsec-title">Disposable Income (Latest)</div>
          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-lg bg-slate-900/50 px-2 py-2">
              <div class="text-[10px] text-slate-500">Per capita</div>
              <div class="text-sm font-semibold text-blue-300">${pc}</div>
            </div>
            <div class="rounded-lg bg-slate-900/50 px-2 py-2">
              <div class="text-[10px] text-slate-500">Per household</div>
              <div class="text-sm font-semibold text-blue-300">${hh}</div>
            </div>
          </div>
        </div>`;
      }

      // ‚îÄ‚îÄ Section E: Age Structure ‚îÄ‚îÄ
      const age = data.age;
      if (age && age.rows && age.rows.length > 0) {
        html += `<div class="dsec">
          <div class="dsec-title">Age Structure</div>
          <canvas id="drawer_age_chart" height="160"></canvas>
          <div class="text-[10px] text-slate-500 font-mono mt-1">Source: ${age.source || 'N/A'} ¬∑ ${age.period || ''}</div>
        </div>`;
      }

      // ‚îÄ‚îÄ Section F: M&A Activity (Global context) ‚îÄ‚îÄ
      const maInd = DASHBOARD_DATA.finance_ma_industry || { rows: [] };
      const maCty = DASHBOARD_DATA.finance_ma_country || { rows: [] };
      if ((maInd.rows && maInd.rows.length > 0) || (maCty.rows && maCty.rows.length > 0)) {
        html += `<div class="dsec">
          <div class="dsec-title">M&A Activity (Global)</div>`;

        if (maInd.rows && maInd.rows.length > 0) {
          html += `<div class="text-[10px] text-slate-500 mb-1">Top 3 Industries by Value</div>
            <div class="space-y-1 mb-3">`;
          maInd.rows.slice(0, 3).forEach(r => {
            html += `<div class="flex items-center justify-between text-xs">
              <span class="text-slate-300">${r.industry}</span>
              <span class="text-slate-400 font-mono">${r.value_usd_bil != null ? '$' + Number(r.value_usd_bil).toFixed(1) + 'B' : '‚Äî'} ¬∑ ${r.deals || 0} deals</span>
            </div>`;
          });
          html += `</div>`;
        }

        if (maCty.rows && maCty.rows.length > 0) {
          html += `<div class="text-[10px] text-slate-500 mb-1">Top 3 Countries by Deals</div>
            <div class="space-y-1">`;
          maCty.rows.slice(0, 3).forEach(r => {
            html += `<div class="flex items-center justify-between text-xs">
              <span class="text-slate-300">${r.country}</span>
              <span class="text-slate-400 font-mono">${r.deals || 0} deals ¬∑ ${r.value_bil != null ? (r.currency || '$') + Number(r.value_bil).toFixed(1) + 'B' : '‚Äî'}</span>
            </div>`;
          });
          html += `</div>`;
        }

        html += `</div>`;
      }

      // ‚îÄ‚îÄ Section G: Insights ‚îÄ‚îÄ
      const insightTrade = _getInsight('trade_flow', 'corridors', geoName) || _getInsight('trade_flow', 'corridors', 'Global');
      const insightWealth = _getInsight('wealth', 'gdp_pc', geoName) || _getInsight('wealth', 'gdp_pc', 'Global');
      if (insightTrade || insightWealth) {
        html += `<div class="dsec">
          <div class="dsec-title">Insights</div>`;
        if (insightTrade && insightTrade.content) {
          html += `<div class="text-xs text-slate-300 mb-2 leading-relaxed">${insightTrade.content}</div>
            <div class="text-[10px] text-slate-500 font-mono mb-3">Source updated: ${_fmtSourceUpdated(insightTrade.source_updated_at)}</div>`;
        }
        if (insightWealth && insightWealth.content) {
          html += `<div class="text-xs text-slate-300 leading-relaxed">${insightWealth.content}</div>
            <div class="text-[10px] text-slate-500 font-mono">Source updated: ${_fmtSourceUpdated(insightWealth.source_updated_at)}</div>`;
        }
        html += `</div>`;
      }

      body.innerHTML = html;

      // ‚îÄ‚îÄ Render Charts (after DOM is ready) ‚îÄ‚îÄ
      requestAnimationFrame(() => renderDrawerCharts(geoName));
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       DRAWER CHARTS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    const chartDefaults = {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#cbd5e1', boxWidth: 8, font: { size: 10 } }, position: 'bottom' },
      },
      scales: {
        x: { ticks: { color: '#94a3b8', font: { size: 9 } }, grid: { color: 'rgba(148,163,184,0.08)' } },
        y: { ticks: { color: '#94a3b8', font: { size: 9 } }, grid: { color: 'rgba(148,163,184,0.08)' } },
      },
    };

    function renderDrawerCharts(geoName) {
      const data = geoDataIndex[geoName];
      if (!data) return;

      // Export/Import line chart
      const eximCtx = document.getElementById('drawer_exim_chart');
      if (eximCtx && data.exim && data.exim.series) {
        const series = data.exim.series;
        const labels = series.map(r => r.period);
        const exp = series.map(r => r.export_usd != null ? r.export_usd / 1e9 : null);
        const imp = series.map(r => r.import_usd != null ? r.import_usd / 1e9 : null);

        drawerCharts.exim = new Chart(eximCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Export (bn)', data: exp, borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', tension: 0.3, borderWidth: 2, pointRadius: 2 },
              { label: 'Import (bn)', data: imp, borderColor: '#34d399', backgroundColor: 'rgba(52,211,153,0.1)', tension: 0.3, borderWidth: 2, pointRadius: 2 },
            ],
          },
          options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.raw != null ? c.raw.toFixed(1) : '‚Äî'}` } } } },
        });
      }

      // GDP per capita line chart
      const wealthCtx = document.getElementById('drawer_wealth_chart');
      if (wealthCtx && data.wealth && data.wealth.series) {
        const series = data.wealth.series;
        const labels = series.map(r => r.period);
        const gdp = series.map(r => r.gdp_per_capita_usd != null ? r.gdp_per_capita_usd : null);

        drawerCharts.wealth = new Chart(wealthCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'GDP pc (US$)', data: gdp, borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.1)', tension: 0.3, borderWidth: 2, pointRadius: 2 },
            ],
          },
          options: {
            ...chartDefaults,
            plugins: {
              ...chartDefaults.plugins,
              tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.raw != null ? '$' + Math.round(c.raw).toLocaleString() : '‚Äî'}` } },
            },
            scales: {
              ...chartDefaults.scales,
              y: { ...chartDefaults.scales.y, ticks: { ...chartDefaults.scales.y.ticks, callback: v => '$' + Number(v).toLocaleString() } },
            },
          },
        });
      }

      // Age structure doughnut
      const ageCtx = document.getElementById('drawer_age_chart');
      if (ageCtx && data.age && data.age.rows && data.age.rows.length > 0) {
        const labels = data.age.rows.map(r => r.label);
        const vals = data.age.rows.map(r => r.pct);

        drawerCharts.age = new Chart(ageCtx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: vals,
              backgroundColor: ['#60a5fa', '#34d399', '#fbbf24', '#fb7185', '#a78bfa'],
              borderColor: 'rgba(15,23,42,0.65)',
              borderWidth: 2,
            }],
          },
          options: {
            responsive: true,
            cutout: '58%',
            plugins: {
              legend: { position: 'right', labels: { color: '#cbd5e1', boxWidth: 10, font: { size: 10 } } },
              tooltip: { callbacks: { label: c => `${c.label}: ${Number(c.parsed).toFixed(1)}%` } },
            },
          },
        });
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       INITIALIZATION
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    function debounce(fn, ms) {
      let t;
      return function() { clearTimeout(t); t = setTimeout(() => fn.apply(this, arguments), ms); };
    }

    async function init() {
      // 1. Build geo index
      buildGeoIndex();

      // 2. Render static parts
      renderExecSummary();
      renderKPIBar();

      // 3. Wire drawer controls
      document.getElementById('drawerClose').addEventListener('click', closeDrawer);
      document.getElementById('drawerOverlay').addEventListener('click', closeDrawer);

      // 4. Load map assets
      try {
        const [world, centroids] = await Promise.all([
          fetch(`${BASE}/static/world-110m.json`).then(r => r.json()),
          fetch(`${BASE}/static/country_centroids.json`).then(r => r.json()),
        ]);
        mapState.world = world;
        mapState.centroids = centroids;
        renderMap();
      } catch (err) {
        console.error('Map load failed:', err);
        document.getElementById('hudLine').textContent = 'Failed to load map data.';
      }

      // 5. Resize handler
      window.addEventListener('resize', debounce(renderMap, 250));
    }

    init();
  </script>
</body>
</html>
