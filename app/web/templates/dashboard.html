<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Trade Analysis</title>
  <link rel="icon" href="{{ base_path }}/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { -ms-overflow-style: none; scrollbar-width: none; }
    html::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
    body { background-color: #0f172a; color: #f8fafc; overflow: auto; -ms-overflow-style: none; }
    body::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
    .card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(51, 65, 85, 1); backdrop-filter: blur(8px); }
  </style>
</head>
<body class="p-4 md:p-8">
  {% set base = base_path or '' %}
  <div class="max-w-7xl mx-auto">
    <header class="mb-8 flex flex-wrap justify-between items-center gap-3">
      <div>
        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
          Global Trade Analysis
        </h1>
        <p class="text-slate-400 text-sm mt-1" style="font-family: cursive;">$POC · data-driven trade insights$</p>
      </div>
      <div class="text-right text-xs text-slate-500 font-mono">
        Visited: {{ visited_count }}<br>{{ now }}
      </div>
      <nav class="w-full text-right text-xs text-slate-400 space-x-3">
        <a class="hover:text-blue-300" href="{{ base }}/health">Health</a>
      </nav>
    </header>

    <section class="card rounded-3xl p-6 md:p-10 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
        <div class="md:col-span-2">
          <h2 class="text-xl md:text-2xl font-bold text-slate-100">One dashboard for global trade signals</h2>
          <p class="text-slate-400 mt-2 leading-relaxed">
            This is the homepage scaffold for <span class="text-slate-200 font-semibold">Global Trade Analysis</span>.
            The goal is to progressively add widgets (trade flows, tariffs, corridors, shipping, and risk) with transparent definitions and reproducible sources.
          </p>
        </div>
        <div class="flex md:justify-end gap-3">
          <a class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-sm font-semibold" href="#widgets">Explore widgets</a>
          <a class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold" href="#about">About</a>
        </div>
      </div>
    </section>

    <section id="widgets" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card rounded-3xl p-6 transition-all hover:border-blue-500/50">
        <div class="text-xs text-slate-400">Widget</div>
        <div class="mt-1 text-xl font-bold">Global Trade Flow</div>
        <p class="mt-2 text-sm text-slate-400 leading-relaxed">Exports/Imports, trade balance, corridors (value & volume), freight (WCI), and port signals. Cadence varies by source.</p>
        <div class="mt-4 text-xs text-slate-500 font-mono">Status: MVP scaffold</div>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <label class="text-xs text-slate-400 font-mono">Scope</label>
          <select id="trade_geo" class="bg-slate-900/60 border border-slate-700 rounded-lg px-2 py-1 text-xs text-slate-200">
            <option>Loading…</option>
          </select>
        </div>

        <div class="mt-4 flex flex-wrap gap-2 text-xs font-mono">
          <button data-tab="corridors" class="trade-tab px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700">Corridors</button>
          <button data-tab="exim" class="trade-tab px-3 py-1 rounded-lg bg-slate-900/40 hover:bg-slate-700">Export/Import</button>
          <button data-tab="balance" class="trade-tab px-3 py-1 rounded-lg bg-slate-900/40 hover:bg-slate-700">Surplus/Deficit</button>
          <button data-tab="wci" class="trade-tab px-3 py-1 rounded-lg bg-slate-900/40 hover:bg-slate-700">Freight (WCI)</button>
          <button data-tab="portwatch" class="trade-tab px-3 py-1 rounded-lg bg-slate-900/40 hover:bg-slate-700">PortWatch</button>
        </div>

        <div class="mt-4 text-sm">
          <div id="trade_panel_corridors" class="trade-panel">
            <div class="text-slate-300 font-semibold">Top corridor (Value)</div>
            <div id="trade_value_top" class="text-slate-400 text-sm mt-1 font-mono">Loading…</div>
            <div class="text-slate-300 font-semibold mt-3">Top corridor (Volume)</div>
            <div id="trade_volume_top" class="text-slate-400 text-sm mt-1 font-mono">Loading…</div>
            <div id="trade_corridors_commentary" class="text-slate-400 text-sm mt-2"></div>
          </div>

          <div id="trade_panel_exim" class="trade-panel hidden">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="text-slate-300 font-semibold">Export</div>
                <div id="trade_export" class="text-slate-400 text-sm mt-1 font-mono">—</div>
              </div>
              <div>
                <div class="text-slate-300 font-semibold">Import</div>
                <div id="trade_import" class="text-slate-400 text-sm mt-1 font-mono">—</div>
              </div>
            </div>
            <div id="trade_exim_commentary" class="text-slate-400 text-sm mt-2"></div>
          </div>

          <div id="trade_panel_balance" class="trade-panel hidden">
            <div class="text-slate-300 font-semibold">Trade balance</div>
            <div id="trade_balance" class="text-slate-400 text-sm mt-1 font-mono">—</div>
            <div id="trade_balance_commentary" class="text-slate-400 text-sm mt-2"></div>
          </div>

          <div id="trade_panel_wci" class="trade-panel hidden">
            <div class="text-slate-300 font-semibold">World Container Index (Drewry)</div>
            <div id="trade_wci" class="text-slate-400 text-sm mt-1 font-mono">—</div>
            <div id="trade_wci_commentary" class="text-slate-400 text-sm mt-2"></div>
          </div>

          <div id="trade_panel_portwatch" class="trade-panel hidden">
            <div class="text-slate-300 font-semibold">IMF PortWatch</div>
            <div id="trade_portwatch" class="text-slate-400 text-sm mt-1 font-mono">—</div>
            <div id="trade_portwatch_commentary" class="text-slate-400 text-sm mt-2"></div>
          </div>

          <div id="trade_period" class="text-xs text-slate-500 mt-4 font-mono"></div>
          <div id="trade_source" class="text-xs text-slate-500 mt-1 font-mono"></div>
        </div>
      </div>

      <div class="card rounded-3xl p-6 transition-all hover:border-emerald-500/50">
        <div class="text-xs text-slate-400">Widget</div>
        <div class="mt-1 text-xl font-bold">Global Wealth Distribution</div>
        <p class="mt-2 text-sm text-slate-400 leading-relaxed">Proxy-based wealth/spending by age group + shift pace (India/Mexico/Singapore/HK).</p>
        <div class="mt-4 text-xs text-slate-500 font-mono">Status: MVP (proxy)</div>
        <div class="mt-4 text-sm">
          <div class="text-slate-300 font-semibold">Fastest shift pace (proxy)</div>
          <div id="wealth_fastest" class="text-slate-400 text-sm mt-1 font-mono">Loading…</div>
          <div id="wealth_source" class="text-xs text-slate-500 mt-3 font-mono"></div>
        </div>
      </div>

      <div class="card rounded-3xl p-6 transition-all hover:border-fuchsia-500/50">
        <div class="text-xs text-slate-400">Widget</div>
        <div class="mt-1 text-xl font-bold">Global Financial Flow</div>
        <p class="mt-2 text-sm text-slate-400 leading-relaxed">Big transactions feed (near-real-time via open news feeds; always source-linked).</p>
        <div class="mt-4 text-xs text-slate-500 font-mono">Status: MVP</div>
        <div class="mt-4 text-sm">
          <div class="text-slate-300 font-semibold">Latest big tickets</div>
          <ul id="finance_list" class="mt-2 space-y-2 text-slate-400 text-sm"></ul>
          <div id="finance_source" class="text-xs text-slate-500 mt-3 font-mono"></div>
        </div>
      </div>
    </section>

    <script>
      const BASE = "{{ base }}";

      function fmtUSD(n) {
        if (n == null) return "—";
        const abs = Math.abs(n);
        if (abs >= 1e12) return (n/1e12).toFixed(2) + "T";
        if (abs >= 1e9) return (n/1e9).toFixed(2) + "B";
        if (abs >= 1e6) return (n/1e6).toFixed(2) + "M";
        return String(n);
      }

      function fmtKG(n) {
        if (n == null) return "—";
        const abs = Math.abs(n);
        if (abs >= 1e12) return (n/1e12).toFixed(2) + "T kg";
        if (abs >= 1e9) return (n/1e9).toFixed(2) + "B kg";
        if (abs >= 1e6) return (n/1e6).toFixed(2) + "M kg";
        return n + " kg";
      }

      function setTradeTab(active) {
        document.querySelectorAll('.trade-panel').forEach(p => p.classList.add('hidden'));
        const panel = document.getElementById('trade_panel_' + active);
        if (panel) panel.classList.remove('hidden');

        document.querySelectorAll('.trade-tab').forEach(b => {
          if (b.dataset.tab === active) {
            b.classList.remove('bg-slate-900/40');
            b.classList.add('bg-slate-800');
          } else {
            b.classList.remove('bg-slate-800');
            b.classList.add('bg-slate-900/40');
          }
        });
      }

      function fmtSignedUSD(n) {
        if (n == null) return '—';
        const sign = n >= 0 ? '+' : '−';
        return sign + '$' + fmtUSD(Math.abs(n));
      }

      let TRADE_DATA = null;

      function renderTrade() {
        if (!TRADE_DATA) return;
        const geo = document.getElementById('trade_geo').value || 'Global';
        const d = (TRADE_DATA.by_geo || {})[geo] || {};

        const v = (d.value_usd_top || [])[0];
        const vol = (d.volume_top || [])[0];
        document.getElementById('trade_value_top').textContent = v ? `${v.origin} → ${v.dest} · $${fmtUSD(v.value_usd)}` : '—';
        document.getElementById('trade_volume_top').textContent = vol ? `${vol.origin} → ${vol.dest} · ${fmtKG(vol.volume_kg)}` : '—';

        document.getElementById('trade_export').textContent = d.export_usd != null ? `$${fmtUSD(d.export_usd)}` : '—';
        document.getElementById('trade_import').textContent = d.import_usd != null ? `$${fmtUSD(d.import_usd)}` : '—';
        document.getElementById('trade_balance').textContent = d.trade_balance_usd != null ? fmtSignedUSD(d.trade_balance_usd) : '—';

        // --- per-tab commentary ---
        const corridorsNote = v || vol
          ? `Commentary: value and volume leaders can differ; use this to spot reroutes or mix changes.`
          : `Commentary: corridor leaders will appear once data is available.`;
        document.getElementById('trade_corridors_commentary').textContent = corridorsNote;

        const bal = d.trade_balance_usd;
        const eximNote = (d.export_usd != null && d.import_usd != null)
          ? `Commentary: ${geo} is currently a ${bal != null && bal >= 0 ? 'net exporter' : 'net importer'} in this period.`
          : `Commentary: export/import will populate once data is available.`;
        document.getElementById('trade_exim_commentary').textContent = eximNote;

        const balanceNote = (bal != null)
          ? `Commentary: ${bal >= 0 ? 'surplus' : 'deficit'} equals export minus import (simple identity).`
          : `Commentary: balance will populate once data is available.`;
        document.getElementById('trade_balance_commentary').textContent = balanceNote;

        const wci = TRADE_DATA.wci || {};
        const wciLine = wci.value_usd_per_40ft != null ? `$${wci.value_usd_per_40ft}/40ft` : '—';
        document.getElementById('trade_wci').textContent = `${wciLine}`;
        document.getElementById('trade_wci_commentary').textContent = wci.analysis_commentary || wci.commentary || 'Commentary: auto-extracted from source.';

        const pw = TRADE_DATA.portwatch || {};
        document.getElementById('trade_portwatch').textContent = pw.commentary || '—';
        document.getElementById('trade_portwatch_commentary').textContent = `Commentary: port signals help validate whether trade changes are demand-led or capacity-led.`;

        document.getElementById('trade_period').textContent = `Period: ${d.period || '—'} · WCI: ${wci.period || '—'} · PortWatch: ${pw.period || '—'}`;
        document.getElementById('trade_source').textContent = `Source: ${TRADE_DATA.source} · Updated: ${TRADE_DATA.updated_at}`;
      }

      async function loadTrade() {
        const res = await fetch(`${BASE}/api/trade/corridors`);
        const data = await res.json();
        TRADE_DATA = data;

        const sel = document.getElementById('trade_geo');
        sel.innerHTML = '';
        (data.geos || ['Global']).forEach(g => {
          const opt = document.createElement('option');
          opt.value = g;
          opt.textContent = g;
          sel.appendChild(opt);
        });
        sel.value = 'Global';
        sel.addEventListener('change', renderTrade);

        document.querySelectorAll('.trade-tab').forEach(b => {
          b.addEventListener('click', () => setTradeTab(b.dataset.tab));
        });
        setTradeTab('corridors');

        renderTrade();
      }

      async function loadWealth() {
        const res = await fetch(`${BASE}/api/wealth/proxy`);
        const data = await res.json();
        const pace = data.shift_pace_proxy || {};
        let best = null;
        for (const [k, v] of Object.entries(pace)) {
          if (best == null || v > best.v) best = {k, v};
        }
        document.getElementById('wealth_fastest').textContent = best ? `${best.k} · +${best.v}% (proxy)` : '—';
        document.getElementById('wealth_source').textContent = `Source: ${data.source} · Updated: ${data.updated_at}`;
      }

      async function loadFinance() {
        const res = await fetch(`${BASE}/api/finance/big-transactions`);
        const data = await res.json();
        const ul = document.getElementById('finance_list');
        ul.innerHTML = '';
        for (const t of (data.transactions || []).slice(0, 5)) {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = t.link;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.className = 'hover:text-fuchsia-300';
          a.textContent = `${t.date} · ${t.type} · $${fmtUSD(t.value_usd)} · ${t.headline}`;
          li.appendChild(a);
          ul.appendChild(li);
        }
        document.getElementById('finance_source').textContent = `Source: ${data.source} · Updated: ${data.updated_at}`;
      }

      Promise.allSettled([loadTrade(), loadWealth(), loadFinance()]).catch(() => {});
    </script>

    <section id="about" class="mt-6 card rounded-3xl p-6">
      <h3 class="text-lg font-bold">Notes</h3>
      <ul class="mt-3 text-sm text-slate-400 space-y-2 list-disc pl-5">
        <li>All definitions should be explicit and source-linked (WTO/UN Comtrade/IMF/World Bank where applicable).</li>
        <li>Methodology will distinguish <span class="text-slate-200">value</span>, <span class="text-slate-200">volume</span>, and <span class="text-slate-200">shipping capacity</span> to avoid ambiguity.</li>
      </ul>
    </section>

    <footer class="mt-8 text-xs text-slate-600">
      Global Trade Analysis · GTA · {{ now }}
    </footer>
  </div>
</body>
</html>
